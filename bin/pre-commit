#!/usr/bin/env bash

PLATFORM_ROOT="$(git rev-parse --show-toplevel)"
PROJECT_ROOT="${PROJECT_ROOT:-"$(cd "$PLATFORM_ROOT"/.. && git rev-parse --show-toplevel)"}"
AUTOLOAD_FILE="$PROJECT_ROOT/vendor/autoload.php"

function onExit {
    if [[ $? != 0 ]]
    then
        echo "Fix the error before commit."
    fi
}
trap onExit EXIT

FILES="$(git diff --cached --name-only --diff-filter=ACMR HEAD | grep -E '\.php$')"

# exit on non-zero return code
set -e

if [[ -z "$FILES" ]]
then
    exit 0
fi

for FILE in $FILES
do
    php -l -d display_errors=0 "$FILE" 1> /dev/null
done

bin/phpstan.phar analyze --level 5 --no-progress --configuration phpstan.neon --autoload-file="$AUTOLOAD_FILE" $FILES


UNSTAGED_FILES="$(git diff --name-only -- $FILES)"

if [[ -n "$UNSTAGED_FILES" ]]
then
    echo "Error: There are staged files with unstaged changes. We cannot automatically fix and add those.

Please add or revert the following files:

$UNSTAGED_FILES
"
    exit 1
fi

# fix code style and update the commit
bin/php-cs-fixer.phar fix --config=.php_cs.dist --quiet --allow-risky=yes -vv $FILES
git add $FILES


