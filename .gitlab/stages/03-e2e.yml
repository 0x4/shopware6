# requires /.gitlab/base.yml

E2E:
    extends:
        - .long-running
    stage: E2E
    needs: []
    services:
        -   name: mariadb:10.3
            alias: database
    variables:
        APP_ENV: e2e
        CYPRESS_baseUrl: "http://localhost:8000"
        CYPRESS_localUsage: 1
        CYPRESS_screenshotsFolder: $CI_PROJECT_DIR/var/log/screenshots
        CYPRESS_DD_API_KEY: "$DATADOG_API_KEY"
        SHOPWARE_HTTP_CACHE_ENABLED: 0
        cypress_usePercy: 'false'
        CYPRESS_TARGET_BRANCH: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME
        CYPRESS_TARGET_COMMIT: $CI_MERGE_REQUEST_DIFF_BASE_SHA
        CYPRESS_COMMIT_BRANCH: $CI_COMMIT_BRANCH
    parallel:
        matrix:
            -   E2E_PROJECT: 'storefront'
                TEST_DIRECTORY: "cypress/integration/**/**/*"
                BROWSER: 'chrome'
                FEATURE_ALL: ["false", "minor", "major"]
            -   E2E_PROJECT: 'admin'
                TEST_DIRECTORY:
                    - "cypress/integration/settings/**/*"
                    - "cypress/integration/catalogue/**/*,cypress/integration/media-marketing/**/*"
                    - "cypress/integration/content/**/*,cypress/integration/customer/**/*,cypress/integration/general/**/*,cypress/integration/order/**/*,cypress/integration/rule-product-stream/**/*"
                BROWSER: 'chrome'
                FEATURE_ALL: ["false", "minor", "major"]
            # firefox
            -   E2E_PROJECT: 'storefront'
                TEST_DIRECTORY: "cypress/integration/**/**/*"
                BROWSER: 'firefox'
                FEATURE_ALL: 'false'
            -   E2E_PROJECT: 'admin'
                TEST_DIRECTORY:
                    - "cypress/integration/settings/**/*"
                    - "cypress/integration/catalogue/**/*,cypress/integration/media-marketing/**/*"
                    - "cypress/integration/content/**/*,cypress/integration/customer/**/*,cypress/integration/general/**/*,cypress/integration/order/**/*,cypress/integration/rule-product-stream/**/*"
                BROWSER: 'firefox'
                FEATURE_ALL: 'false'

    script:
        - composer run init:e2e:$E2E_PROJECT
        - composer run e2e:prepare
        - composer run e2e:$E2E_PROJECT:cypress -- run
            --browser chrome
            --spec "$TEST_DIRECTORY"
            --headless
    after_script:
        - mkdir $CI_PROJECT_DIR/var/log/e2e
        - composer run npm:e2e:$E2E_PROJECT -- run combine-reports
        - composer run npm:e2e:$E2E_PROJECT -- run generate-report
        - mv $ADMIN_PATH/test/e2e/cypress/results/single-reports/*.xml var/log/e2e/ || true
        - mv $STOREFRONT_PATH/test/e2e/cypress/results/single-reports/*.xml var/log/e2e/ || true
        - mv $ADMIN_PATH/test/e2e/mochareports/ var/log/e2e/ || true
        - mv $STOREFRONT_PATH/test/e2e/mochareports/ var/log/e2e/ || true
        - !reference [.upload-junit-xml, after_script]
    artifacts:
        when: always
        paths:
            - var/log/*
        reports:
            junit: var/log/e2e/*.xml

E2E install NL:
    extends:
        - .long-running
    stage: E2E
    needs: [ ]
    services:
        -   name: mariadb:10.3
            alias: database
    variables:
        APP_ENV: e2e
        APP_DEBUG: 'true'
        CYPRESS_baseUrl: "http://localhost:8000"
        CYPRESS_localUsage: 1
        CYPRESS_screenshotsFolder: $CI_PROJECT_DIR/var/log/screenshots
        CYPRESS_DD_API_KEY: "$DATADOG_API_KEY"
        SHOPWARE_HTTP_CACHE_ENABLED: 0
        cypress_usePercy: 'false'
        E2E_PROJECT: recovery
        CYPRESS_dbHost: database
        CYPRESS_dbPassword: $MYSQL_ROOT_PASSWORD
        CYPRESS_locale: nl-NL
    script:
        - apt-get update && apt-get -y install jq
        - export PLATFORM_VERSION="$(jq -r .version < composer.json)"
        # fake version by using the latest tag if not set
        - >
          if [[ "$PLATFORM_VERSION" = "null" ]]; then
            LATEST_TAG="$(git -c 'versionsort.suffix=-' ls-remote --exit-code --refs --sort='version:refname' --tags | tail --lines=1 | cut --delimiter='/' --fields=3)"
            PLATFORM_VERSION="${LATEST_TAG#"v"}"
            composer config version "$PLATFORM_VERSION"
            composer update
          fi
        - rm .env install.lock || true
        - mkdir -p config/packages || true
        - >
          cat > config/packages/ci.yaml <<EOF

          shopware:
            store:
              frw: true
          EOF
        - composer run init:e2e:recovery
        - composer run e2e:recovery:cypress -- run
            --browser chrome
            --spec "cypress/integration/installer/install_nl.spec.js"
            --headless
        - .gitlab/bin/install_store_plugin.bash SwagLanguagePack SwagPayPal
        - composer run e2e:prepare
        - composer run e2e:recovery:cypress -- run
            --browser chrome
            --spec "cypress/integration/scenarios/**/*.spec.js"
            --headless
    after_script:
        - mkdir -p $CI_PROJECT_DIR/var/log/e2e $CI_PROJECT_DIR/src/Recovery/Test/e2e/cypress/mochareports || true
        - composer run npm:e2e:$E2E_PROJECT -- run combine-reports
        - composer run npm:e2e:$E2E_PROJECT -- run generate-report
        - mv $CI_PROJECT_DIR/src/Recovery/Test/e2e/cypress/results/single-reports/*.xml var/log/e2e/ || true
        - mv $CI_PROJECT_DIR/src/Recovery/Test/e2e/mochareports/ var/log/e2e/ || true
        - !reference [ .upload-junit-xml, after_script ]
    artifacts:
        when: always
        paths:
            - var/log/*
        reports:
            junit: var/log/e2e/*.xml
